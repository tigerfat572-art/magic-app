<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Calculator</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* --- è®¾ç½®é¡µé¢ --- */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; color: white;
            padding-top: calc(env(safe-area-inset-top) + 60px);
            padding-left: 16px; padding-right: 16px; 
            padding-bottom: 120px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior: contain;
        }

        .setup-header { width: 100%; max-width: 350px; margin-bottom: 30px; padding-left: 10px; flex-shrink: 0; }
        .setup-title { font-size: 34px; font-weight: 700; margin-bottom: 5px; letter-spacing: 0.5px; }
        .setup-subtitle { font-size: 15px; color: #8e8e93; }

        .section-group {
            width: 100%; max-width: 350px; background: #1c1c1e; border-radius: 12px;
            overflow: hidden; margin-bottom: 24px; flex-shrink: 0;
        }

        .group-title {
            width: 100%; max-width: 350px; padding: 0 0 8px 10px; 
            font-size: 13px; color: #8e8e93; text-transform: uppercase; flex-shrink: 0;
        }

        .list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; background: #1c1c1e; border-bottom: 1px solid #38383a;
            transition: background 0.2s; cursor: pointer;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background: #2c2c2e; }

        .item-label { font-size: 17px; font-weight: 400; }
        .check-icon { color: #ff9f0a; font-weight: bold; margin-left: 10px; display: none; }
        .list-item.selected .check-icon { display: block; }
        .list-item.selected .item-label { color: #ff9f0a; }

        .input-row { padding: 0; border-bottom: 1px solid #38383a; }
        .input-row:last-child { border-bottom: none; }
        .magic-input {
            width: 100%; padding: 16px; background: transparent; border: none;
            color: white; font-size: 17px; outline: none;
        }
        .magic-input::placeholder { color: #636366; }
        
        .file-row {
            position: relative; padding: 16px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #38383a;
        }
        .file-row:last-child { border-bottom: none; }

        .file-label { color: #0a84ff; font-size: 17px; }
        
        .file-status-container { display: flex; align-items: center; gap: 8px; z-index: 20; position: relative; }
        .file-status { font-size: 14px; color: #636366; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .clear-img-btn {
            background: rgba(60, 60, 60, 0.8);
            color: #ff453a;
            border: none;
            border-radius: 50%;
            width: 22px; height: 22px;
            display: none;
            align-items: center; justify-content: center;
            font-size: 16px; font-weight: bold;
            cursor: pointer;
            padding: 0; line-height: 1;
        }
        .clear-img-btn:active { background: rgba(80, 80, 80, 1); }

        input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
            z-index: 10;
        }

        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #39393d; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: #30d158; }
        input:checked + .slider:before { transform: translateX(20px); }

        .hidden-section { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-container {
            width: 100%; max-width: 350px;
            display: flex; gap: 10px; margin-bottom: 20px; margin-top: 10px; flex-shrink: 0;
        }
        
        .action-btn {
            flex: 1; border: none; padding: 16px; border-radius: 12px; font-size: 17px;
            font-weight: 600; cursor: pointer; text-align: center;
        }
        .action-btn:active { opacity: 0.8; }

        .save-btn { background-color: #3a3a3c; color: #0a84ff; }
        .start-btn { background-color: #ff9f0a; color: white; }

        /* --- è®¡ç®—å™¨ä¸»ä½“ --- */
        .calculator-wrapper { display: none; height: 100%; width: 100%; flex-direction: column; justify-content: flex-end; }
        .calculator { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; max-width: 500px; margin: 0 auto; position: relative; }
        
        .display-container { flex-grow: 1; display: flex; justify-content: flex-end; align-items: flex-end; padding: 20px 24px 15px 24px; position: relative; overflow: hidden;}
        
        #display { 
            color: white; font-size: 90px; font-weight: 300; line-height: 1; 
            text-align: right; 
            white-space: pre-wrap; 
            word-break: break-all;
            outline: none; min-width: 50px; width: 100%;
            caret-color: #ff9f0a; 
            display: flex; justify-content: flex-end; align-items: flex-end;
        }
        
        #display img {
            max-height: 350px;
            max-width: 100%;
            object-fit: contain;
            border-radius: 8px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #display[contenteditable="true"] { cursor: text; }

        #remote-indicator {
            position: absolute; top: calc(env(safe-area-inset-top) + 10px); left: 20px;
            font-size: 12px; color: #30d158; opacity: 0; transition: opacity 0.5s;
            pointer-events: none;
        }

        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; padding: 0 14px 14px 14px; position: relative; }
        
        #ui-layer-mask { 
            position: absolute; top: -80px; right: 0; width: 25%; height: 100px; 
            background: transparent !important; z-index: 999;
            -webkit-tap-highlight-color: transparent; outline: none;
        }
        
        #status-dot { position: absolute; bottom: 15px; left: 15px; width: 4px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 300; }
        
        .btn { 
            aspect-ratio: 1; width: 100%; border-radius: 50%; border: none; 
            font-size: 34px; font-weight: 400; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            transition: background-color 0.2s ease-out; 
            outline: none; -webkit-tap-highlight-color: transparent; 
            /* æ–°å¢ï¼šå…è®¸å­å…ƒç´ æº¢å‡ºæ˜¾ç¤ºå¸½å­ */
            position: relative; overflow: visible;
        }
        
        .btn-num { background-color: #333333; color: white; }
        .btn-fn { background-color: #a5a5a5; color: black; }
        .btn-op { background-color: #ff9f0a; color: white; font-size: 40px; padding-bottom: 4px; }
        
        .btn.active-state { transition: none !important; }
        .btn-num.active-state { background-color: #737373 !important; }
        .btn-fn.active-state { background-color: #d9d9d9 !important; }
        .btn-op.active-state { background-color: #fbc78d !important; color: #ff9f0a !important; }

        .btn-num:active { background-color: #737373 !important; }
        .btn-fn:active { background-color: #d9d9d9 !important; }
        .btn-op:active { background-color: #fbc78d !important; color: #ff9f0a !important; }
        
        .btn-zero { grid-column: span 2; aspect-ratio: auto; height: 100%; border-radius: 100px; justify-content: flex-start; padding-left: 34px; }

        /* --- åœ£è¯ç‰¹æ•ˆæ ·å¼ --- */
        #snow-canvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; /* ç¡®ä¿é›ªèŠ±ä¸æŒ¡ä½æ“ä½œ */
            z-index: 1500;
            display: none;
        }

        .santa-hat {
            position: absolute;
            top: -12px;
            right: -8px;
            width: 32px;
            height: 32px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.5) rotate(-10deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .santa-hat.visible {
            opacity: 1;
            transform: scale(1) rotate(15deg);
        }

        /* 0é”®çš„å¸½å­ä½ç½®å¾®è°ƒ */
        .btn-zero .santa-hat { right: 50%; margin-right: -100px; }

    </style>
</head>
<body ontouchstart="" oncontextmenu="return false;">

    <canvas id="snow-canvas"></canvas>

    <div id="setup-screen">
        <div class="setup-header">
            <div class="setup-title">Magic Panghu</div>
            <div class="setup-subtitle">é­”æœ¯è®¾ç½®</div>
        </div>
        
        <div class="section-group">
            <div class="list-item selected" id="mode-time" onclick="selectMode('time')">
                <span class="item-label">å½“å‰æ—¶é—´ (MMDDHHmm)</span>
                <span class="check-icon">âœ“</span>
            </div>
            <div class="list-item" id="mode-fixed" onclick="selectMode('fixed')">
                <span class="item-label">å›ºå®šæ•°å­—</span>
                <span class="check-icon">âœ“</span>
            </div>
            <div class="input-row hidden-section" id="fixed-input-row">
                <input type="number" id="fixed-number-input" class="magic-input" placeholder="åœ¨æ­¤è¾“å…¥é¢„è®¾ç»“æœ...">
            </div>
        </div>

        <div class="group-title">å½©è›‹åŠŸèƒ½</div>
        <div class="section-group">
            <div class="list-item">
                <span class="item-label">ğŸ„ åœ£è¯æ¨¡å¼ (1225 Ã· 0)</span>
                <label class="switch">
                    <input type="checkbox" id="xmas-toggle" onchange="toggleXmasMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-title">ç¬¬ä¸€æ¬¡ é™¤ä»¥ 0 (é“ºå«)</div>
        <div class="section-group">
            <div class="input-row">
                <input type="text" id="div-zero-1-text" class="magic-input" placeholder="æ˜¾ç¤ºæ–‡æœ¬ (é»˜è®¤: é”™è¯¯)">
            </div>
            <div class="file-row">
                <span class="file-label">æ˜¾ç¤ºå›¾ç‰‡</span>
                <div class="file-status-container">
                    <span id="img-status-1" class="file-status">æœªé€‰æ‹©</span>
                    <button class="clear-img-btn" id="btn-clear-1" onclick="clearImage(event, 0)">Ã—</button>
                </div>
                <input type="file" id="file-input-1" accept="image/*" onchange="handleImageSelect(this, 0)">
            </div>
        </div>

        <div class="group-title">ç¬¬äºŒæ¬¡ é™¤ä»¥ 0 (é¢„è¨€)</div>
        <div class="section-group">
            <div class="input-row">
                <input type="text" id="div-zero-2-text" class="magic-input" placeholder="æ˜¾ç¤ºæ–‡æœ¬ (é»˜è®¤: é”™è¯¯)">
            </div>
            <div class="file-row">
                <span class="file-label">æ˜¾ç¤ºå›¾ç‰‡</span>
                <div class="file-status-container">
                    <span id="img-status-2" class="file-status">æœªé€‰æ‹©</span>
                    <button class="clear-img-btn" id="btn-clear-2" onclick="clearImage(event, 1)">Ã—</button>
                </div>
                <input type="file" id="file-input-2" accept="image/*" onchange="handleImageSelect(this, 1)">
            </div>
        </div>

        <div class="section-group">
            <div class="list-item">
                <span class="item-label">è¿œç¨‹åŠ©æ‰‹æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="remote-toggle" onchange="toggleRemoteSettings()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="remote-settings-block" class="hidden-section">
                <div class="list-item selected" id="role-calc" onclick="selectRole('calc')">
                    <span class="item-label">æœ¬æœºä½œä¸º: é­”æœ¯è®¡ç®—å™¨</span>
                    <span class="check-icon">âœ“</span>
                </div>
                <div class="list-item" id="role-remote" onclick="selectRole('remote')">
                    <span class="item-label">æœ¬æœºä½œä¸º: é¥æ§åŠ©æ‰‹</span>
                    <span class="check-icon">âœ“</span>
                </div>
                <div class="input-row">
                    <input type="text" id="room-id" class="magic-input" placeholder="æˆ¿é—´å· (ä¾‹å¦‚: 888)" value="888">
                </div>
            </div>
        </div>

        <div class="btn-container">
            <button class="action-btn save-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            <button class="action-btn start-btn" onclick="startApp()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </div>

    <div class="calculator-wrapper" id="calc-app">
        <div class="calculator">
            <div id="remote-indicator">åŠ©æ‰‹æ¨¡å¼: æœªè¿æ¥</div>
            <div id="status-dot"></div>
            
            <div class="display-container">
                <div id="display">0</div>
            </div>
            
            <div class="buttons">
                <div id="ui-layer-mask"></div>
                
                <button id="btn-AC" class="btn btn-fn" 
                        ontouchstart="startAcLongPress(event)" 
                        ontouchend="endAcLongPress(event)" 
                        onmousedown="startAcLongPress(event)" 
                        onmouseup="endAcLongPress(event)"
                        onmouseleave="cancelAcLongPress()">AC</button>
                
                <button id="btn-PLUS_MINUS" class="btn btn-fn" onclick="onBtnClick('+/-')">+/-</button>
                <button id="btn-PERCENT" class="btn btn-fn" onclick="onBtnClick('%')">%</button>
                <button id="btn-DIV" class="btn btn-op" onclick="onBtnClick('/')">Ã·</button>
                <button id="btn-7" class="btn btn-num" onclick="onBtnClick('7')">7</button>
                <button id="btn-8" class="btn btn-num" onclick="onBtnClick('8')">8</button>
                <button id="btn-9" class="btn btn-num" onclick="onBtnClick('9')">9</button>
                <button id="btn-MUL" class="btn btn-op" onclick="onBtnClick('*')">Ã—</button>
                <button id="btn-4" class="btn btn-num" onclick="onBtnClick('4')">4</button>
                <button id="btn-5" class="btn btn-num" onclick="onBtnClick('5')">5</button>
                <button id="btn-6" class="btn btn-num" onclick="onBtnClick('6')">6</button>
                <button id="btn-SUB" class="btn btn-op" onclick="onBtnClick('-')">-</button>
                <button id="btn-1" class="btn btn-num" onclick="onBtnClick('1')">1</button>
                <button id="btn-2" class="btn btn-num" onclick="onBtnClick('2')">2</button>
                <button id="btn-3" class="btn btn-num" onclick="onBtnClick('3')">3</button>
                <button id="btn-ADD" class="btn btn-op" onclick="onBtnClick('+')">+</button>
                <button id="btn-0" class="btn btn-num btn-zero" onclick="onBtnClick('0')">0</button>
                <button id="btn-DOT" class="btn btn-num" onclick="onBtnClick('.')">.</button>
                <button id="btn-EQUAL" class="btn btn-op" onclick="onBtnClick('=')">=</button>
            </div>
        </div>
    </div>

    <script>
        /* --- å…¨å±€å˜é‡ --- */
        let appRole = 'calc'; 
        let magicMode = 'time'; 
        let isXmasMode = false; // æ–°å¢ï¼šåœ£è¯æ¨¡å¼å¼€å…³
        let fixedTargetValue = 0;
        
        let divZeroConfig = [
            { text: 'é”™è¯¯', img: null },
            { text: 'é”™è¯¯', img: null }
        ];
        let divZeroCounter = 0; 

        let mqttClient = null;
        let roomId = '888';
        let acTimer = null;
        let isRemoteEnabled = false; 
        let isComposing = false; 

        const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
        const mqttOptions = {
            clean: true,
            connectTimeout: 5000,
            reconnectPeriod: 1000,
            keepalive: 60
        };
        
        const displayElement = document.getElementById('display');
        
        const keyMap = {
            'AC': 'btn-AC', '+/-': 'btn-PLUS_MINUS', '%': 'btn-PERCENT',
            '/': 'btn-DIV', 'Ã·': 'btn-DIV', '7': 'btn-7', '8': 'btn-8', '9': 'btn-9',
            '*': 'btn-MUL', 'Ã—': 'btn-MUL', '4': 'btn-4', '5': 'btn-5', '6': 'btn-6',
            '-': 'btn-SUB', '1': 'btn-1', '2': 'btn-2', '3': 'btn-3',
            '+': 'btn-ADD', '0': 'btn-0', '.': 'btn-DOT', '=': 'btn-EQUAL'
        };

        function throttle(func, limit) {
            let lastFunc; let lastRan;
            return function() {
                const context = this; const args = arguments;
                if (!lastRan) { func.apply(context, args); lastRan = Date.now(); } 
                else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) { func.apply(context, args); lastRan = Date.now(); }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }

        /* --- å­˜å‚¨/è¯»å– é€»è¾‘ --- */
        function saveSettings() {
            divZeroConfig[0].text = document.getElementById('div-zero-1-text').value;
            divZeroConfig[1].text = document.getElementById('div-zero-2-text').value;
            
            const settings = {
                mode: magicMode,
                xmasMode: document.getElementById('xmas-toggle').checked, // ä¿å­˜åœ£è¯è®¾ç½®
                fixedValue: document.getElementById('fixed-number-input').value,
                divZeroConfig: divZeroConfig, 
                isRemote: document.getElementById('remote-toggle').checked,
                role: appRole,
                roomId: document.getElementById('room-id').value
            };

            try {
                localStorage.setItem('magicCalcSettings', JSON.stringify(settings));
                alert('é…ç½®å·²ä¿å­˜ï¼ä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨åŠ è½½ã€‚');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªå¤§ã€‚è¯·å°è¯•å‹ç¼©å›¾ç‰‡ã€‚');
                console.error(e);
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('magicCalcSettings');
            if (!saved) return;

            try {
                const s = JSON.parse(saved);
                if (s.mode) selectMode(s.mode);
                if (s.fixedValue) document.getElementById('fixed-number-input').value = s.fixedValue;
                
                // è¯»å–åœ£è¯æ¨¡å¼è®¾ç½®
                if (s.xmasMode !== undefined) {
                    isXmasMode = s.xmasMode;
                    document.getElementById('xmas-toggle').checked = isXmasMode;
                }

                if (s.divZeroConfig) {
                    divZeroConfig = s.divZeroConfig;
                    if(divZeroConfig[0].text) document.getElementById('div-zero-1-text').value = divZeroConfig[0].text;
                    if(divZeroConfig[1].text) document.getElementById('div-zero-2-text').value = divZeroConfig[1].text;
                    updateImageStatusUI(0);
                    updateImageStatusUI(1);
                }
                if (s.isRemote) {
                    document.getElementById('remote-toggle').checked = true;
                    toggleRemoteSettings();
                }
                if (s.role) selectRole(s.role);
                if (s.roomId) document.getElementById('room-id').value = s.roomId;

            } catch (e) {
                console.error("è¯»å–å­˜æ¡£å¤±è´¥", e);
            }
        }

        function handleImageSelect(input, index) {
            const statusId = index === 0 ? 'img-status-1' : 'img-status-2';
            const statusEl = document.getElementById(statusId);

            if (input.files && input.files[0]) {
                const file = input.files[0];
                statusEl.innerText = "è¯»å–ä¸­...";
                const reader = new FileReader();
                reader.onload = function(e) {
                    divZeroConfig[index].img = e.target.result;
                    updateImageStatusUI(index);
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage(e, index) {
            e.stopPropagation();
            e.preventDefault();
            divZeroConfig[index].img = null;
            const inputId = index === 0 ? 'file-input-1' : 'file-input-2';
            document.getElementById(inputId).value = '';
            updateImageStatusUI(index);
        }

        function updateImageStatusUI(index) {
            const statusId = index === 0 ? 'img-status-1' : 'img-status-2';
            const btnId = index === 0 ? 'btn-clear-1' : 'btn-clear-2';
            const statusEl = document.getElementById(statusId);
            const btnEl = document.getElementById(btnId);

            if (divZeroConfig[index].img) {
                statusEl.innerText = "å·²åŠ è½½å›¾ç‰‡";
                statusEl.style.color = "#30d158";
                btnEl.style.display = 'flex';
            } else {
                statusEl.innerText = "æœªé€‰æ‹©";
                statusEl.style.color = "#636366";
                btnEl.style.display = 'none';
            }
        }


        /* --- è®¾ç½®é€»è¾‘ --- */
        function selectMode(mode) {
            magicMode = mode;
            document.getElementById('mode-time').classList.remove('selected');
            document.getElementById('mode-fixed').classList.remove('selected');
            const fixedInputRow = document.getElementById('fixed-input-row');
            if (mode === 'time') {
                document.getElementById('mode-time').classList.add('selected');
                fixedInputRow.style.display = 'none';
            } else {
                document.getElementById('mode-fixed').classList.add('selected');
                fixedInputRow.style.display = 'block';
            }
        }
        
        function toggleXmasMode() {
            isXmasMode = document.getElementById('xmas-toggle').checked;
        }

        function toggleRemoteSettings() {
            const toggle = document.getElementById('remote-toggle');
            const settingsBlock = document.getElementById('remote-settings-block');
            isRemoteEnabled = toggle.checked;
            if (isRemoteEnabled) {
                settingsBlock.style.display = 'block';
            } else {
                settingsBlock.style.display = 'none';
                selectRole('calc');
            }
        }

        function selectRole(role) {
            appRole = role;
            document.getElementById('role-calc').classList.remove('selected');
            document.getElementById('role-remote').classList.remove('selected');
            if (role === 'calc') {
                document.getElementById('role-calc').classList.add('selected');
            } else {
                document.getElementById('role-remote').classList.add('selected');
            }
        }

        function startApp() {
            roomId = document.getElementById('room-id').value || '888';
            
            if (magicMode === 'fixed') {
                const val = document.getElementById('fixed-number-input').value;
                if (!val && appRole === 'calc') { alert("è¯·è¾“å…¥å›ºå®šæ•°å­—"); return; }
                fixedTargetValue = parseFloat(val);
            }

            const t1 = document.getElementById('div-zero-1-text').value;
            const t2 = document.getElementById('div-zero-2-text').value;
            if (t1) divZeroConfig[0].text = t1;
            if (t2) divZeroConfig[1].text = t2;
            
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('calc-app').style.display = 'flex';

            if (appRole === 'calc') {
                document.getElementById('ui-layer-mask').style.display = 'block';
                displayElement.contentEditable = "false"; 
                if (isRemoteEnabled) {
                    initMqttReceiver();
                }
                
                // é¢„åŠ è½½åœ£è¯å¸½DOM
                initSantaHats(); 
            } else {
                document.getElementById('ui-layer-mask').style.display = 'none';
                document.getElementById('remote-indicator').style.opacity = '1';
                displayElement.contentEditable = "true"; 
                
                displayElement.addEventListener('compositionstart', () => { isComposing = true; });
                displayElement.addEventListener('compositionend', (e) => {
                    isComposing = false;
                    setTimeout(() => { resizeFont(); sendThrottledSyncContent(); }, 50);
                });
                displayElement.addEventListener('input', (e) => {
                    if (isComposing) return;
                    resizeFont();
                    sendThrottledSyncContent();
                });

                initMqttSender();
            }
        }

        /* --- æŒ‰é’®é€»è¾‘ --- */
        function onBtnClick(key) {
            if (appRole === 'remote') {
                handleRemoteInput(key);
            } else {
                handleInput(key);
            }
        }

        /* --- åŠ©æ‰‹ç«¯é€»è¾‘ --- */
        function handleRemoteInput(key) {
            const cmdKeys = [
                '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', 
                '+', '-', '*', 'Ã—', '/', 'Ã·', '=', 'AC', '+/-', '%'
            ];
            
            let standardKey = key;
            if (key === 'MUL') standardKey = '*';
            if (key === 'DIV') standardKey = '/';
            if (key === 'ADD') standardKey = '+';
            if (key === 'SUB') standardKey = '-';
            if (key === 'EQUAL') standardKey = '=';

            if (navigator.vibrate) navigator.vibrate(30);

            if (cmdKeys.includes(standardKey)) {
                if (standardKey === 'AC') {
                    displayElement.innerHTML = '0'; 
                } else {
                    const ops = ['+', '-', '*', 'Ã—', '/', 'Ã·', '=', 'AC', '+/-', '%'];
                    if (ops.includes(standardKey)) {
                        displayElement.innerHTML = ''; 
                    } else {
                        let currentText = displayElement.innerText;
                        const hasImage = displayElement.querySelector('img') !== null;
                        if (currentText === '0' || currentText === '' || hasImage) {
                            displayElement.innerText = standardKey;
                        } else {
                            displayElement.innerText += standardKey;
                        }
                    }
                }
                
                sendCmdContent(standardKey);
                resizeFont();
                return; 
            }

            let currentText = displayElement.innerText;
            const hasImage = displayElement.querySelector('img') !== null;

            if (currentText === '0' || currentText === '' || hasImage) {
                displayElement.innerText = standardKey;
            } else {
                displayElement.innerText += standardKey;
            }

            resizeFont();
            sendThrottledSyncContent(); 
        }

        const sendThrottledSyncContent = throttle(function() {
            if (isComposing) return; 
            if (mqttClient && mqttClient.connected) {
                const content = displayElement.innerText;
                mqttClient.publish(`magic-calc/${roomId}`, `TXT:${content}`, { qos: 0, retain: false });
            }
        }, 80);

        function sendCmdContent(key) {
            if (mqttClient && mqttClient.connected) {
                mqttClient.publish(`magic-calc/${roomId}`, `CMD:${key}`, { qos: 0, retain: false });
            }
        }

        function simulateRemotePress(key) {
            const btnId = keyMap[key];
            if (btnId) {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.add('active-state');
                    setTimeout(() => {
                        btn.classList.remove('active-state');
                    }, 120); 
                }
            }
        }

        /* --- MQTT æ¥æ”¶ --- */
        function initMqttReceiver() {
            mqttClient = mqtt.connect(mqttBroker, mqttOptions);
            
            mqttClient.on('connect', () => {
                mqttClient.subscribe(`magic-calc/${roomId}`, { qos: 0 });
                statusDot.style.opacity = '1';
                setTimeout(() => statusDot.style.opacity = '0', 800);
            });

            mqttClient.on('message', (topic, message) => {
                const msg = message.toString();
                
                if (msg.startsWith('TXT:')) {
                    const content = msg.substring(4);
                    if (content === '0') {
                        displayElement.innerHTML = '0';
                        currentDisplay = '0';
                    } else {
                        displayElement.innerText = content;
                    }
                    const safeNum = parseFloat(content);
                    if (!isNaN(safeNum)) currentDisplay = String(safeNum);
                    else currentDisplay = "0";
                    resizeFont();
                } 
                else if (msg.startsWith('CMD:')) {
                    const cmdKey = msg.substring(4);
                    simulateRemotePress(cmdKey);
                    handleInput(cmdKey);
                }
                else {
                    handleInput(msg);
                }
            });
        }

        function initMqttSender() {
            mqttClient = mqtt.connect(mqttBroker, mqttOptions);
            const indicator = document.getElementById('remote-indicator');
            mqttClient.on('connect', () => {
                indicator.innerText = `åŠ©æ‰‹æ¨¡å¼: å·²è¿æ¥ (${roomId})`;
                indicator.style.color = '#30d158';
                if(navigator.vibrate) navigator.vibrate(200);
            });
            mqttClient.on('reconnect', () => {
                indicator.innerText = "é‡è¿ä¸­...";
                indicator.style.color = '#ff9f0a';
            });
        }

        /* --- äº¤äº’ä¸ACé•¿æŒ‰ --- */
        function startAcLongPress(e) {
            if (acTimer) clearTimeout(acTimer);
            acTimer = setTimeout(() => {
                if (navigator.vibrate) navigator.vibrate(100);
                if (mqttClient) mqttClient.end();
                location.reload(); 
            }, 1500);
        }
        function endAcLongPress(e) {
            if (acTimer) {
                clearTimeout(acTimer);
                acTimer = null;
                if (e && e.cancelable) e.preventDefault();
                onBtnClick('AC');
            }
        }
        function cancelAcLongPress() { if (acTimer) clearTimeout(acTimer); }

        /* --- è®¡ç®—å™¨é€»è¾‘ --- */
        let currentDisplay = '0';
        let previousValue = null;
        let currentOperator = null;
        let waitingForOperand = false;
        let _isReady = false;       
        let _isFrozen = false;      
        let _isPostReveal = false;  
        
        const hiddenBtn = document.getElementById('ui-layer-mask');
        const statusDot = document.getElementById('status-dot');

        hiddenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault(); 
            if (appRole === 'remote') return; 

            if (!_isFrozen && !_isPostReveal) {
                _isReady = true;
                statusDot.style.opacity = '1'; 
            }
        });

        function handleInput(val) {
            if (document.getElementById('setup-screen').style.display === 'flex') return;
            if (_isFrozen) return;
            if (_isPostReveal) {
                if (val === '=') finalizeMagic();
                return;
            }

            if (!isNaN(val) || val === '.') {
                inputDigit(val);
            } else if (val === 'AC') {
                resetCalculator();
            } else if (val === '+/-') {
                currentDisplay = (parseFloat(currentDisplay) * -1).toString();
                updateDisplay();
            } else if (val === '%') {
                currentDisplay = (parseFloat(currentDisplay) / 100).toString();
                updateDisplay();
            } else {
                handleOperator(val);
            }
        }

        function inputDigit(digit) {
            const currentText = displayElement.innerText;
            const hasImage = displayElement.querySelector('img') !== null;

            if ((isNaN(parseFloat(currentText)) && currentText !== '.') || hasImage) {
                displayElement.innerHTML = '';
                currentDisplay = '0';
                waitingForOperand = false;
            }

            if (currentDisplay.length > 11 && !waitingForOperand) return;
            if (waitingForOperand) {
                currentDisplay = String(digit);
                waitingForOperand = false;
            } else {
                currentDisplay = currentDisplay === '0' ? String(digit) : currentDisplay + digit;
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            let inputValue = parseFloat(displayElement.innerText);
            if (isNaN(inputValue)) inputValue = 0;

            if (nextOperator === '+' && _isReady) {
                startMagicSequence(inputValue);
                return;
            }
            if (previousValue == null) {
                previousValue = inputValue;
            } else if (currentOperator) {
                const resultObj = calculate(previousValue, inputValue, currentOperator);
                
                // å¤„ç†åœ£è¯ç‰¹æ•ˆæˆ–é™¤ä»¥0ç‰¹æ•ˆ
                if (typeof resultObj === 'object' && resultObj.isDivZero) {
                     if (resultObj.isXmas) {
                         // åœ£è¯æ¨¡å¼ç‰¹æ®Šå¤„ç†
                         currentDisplay = "0"; // å½’é›¶ï¼Œå…è®¸ç»§ç»­æ“ä½œ
                         previousValue = null;
                         currentOperator = null;
                         waitingForOperand = true;
                         updateDisplay();
                         return;
                     }
                     
                     if (resultObj.img) {
                         displayElement.innerHTML = `<img src="${resultObj.img}" />`;
                     } else {
                         displayElement.innerText = resultObj.text;
                     }
                     currentDisplay = "0";
                     previousValue = null;
                     currentOperator = null;
                     waitingForOperand = true;
                     return;
                }
                
                const newValue = resultObj;
                previousValue = newValue;
                currentDisplay = String(newValue);
                updateDisplay();
            }
            waitingForOperand = true;
            currentOperator = nextOperator;
        }

        function calculate(first, second, operator) {
            if (operator === '+') return first + second;
            if (operator === '-') return first - second;
            if (operator === '*') return first * second;
            if (operator === '/') {
                if (Number(second) === 0) {
                    // --- åœ£è¯å½©è›‹æ£€æŸ¥ ---
                    if (isXmasMode && Number(first) === 1225) {
                        startChristmasEffect();
                        return { isDivZero: true, isXmas: true };
                    }
                    
                    // --- åŸæœ‰é™¤ä»¥0é€»è¾‘ ---
                    let configIndex = divZeroCounter;
                    if (configIndex >= divZeroConfig.length) {
                        configIndex = divZeroConfig.length - 1;
                    }
                    const targetConfig = divZeroConfig[configIndex];
                    divZeroCounter++;
                    return { 
                        isDivZero: true, 
                        text: targetConfig.text, 
                        img: targetConfig.img 
                    };
                }
                return first / second;
            }
            return second;
        }

        function resetCalculator() {
            currentDisplay = '0';
            previousValue = null;
            currentOperator = null;
            waitingForOperand = false;
            _isReady = false;
            _isFrozen = false;
            _isPostReveal = false;
            divZeroCounter = 0;
            statusDot.style.opacity = '0';
            displayElement.innerHTML = '0';
            resizeFont();
        }

        function updateDisplay() {
            if (displayElement.querySelector('img')) return;
            displayElement.innerText = currentDisplay;
            resizeFont();
        }

        function resizeFont() {
            if (displayElement.querySelector('img')) return;
            const text = displayElement.innerText;
            const len = text.length;
            if (len > 15) displayElement.style.fontSize = '40px';
            else if (len > 9) displayElement.style.fontSize = '50px';
            else if (len > 6) displayElement.style.fontSize = '70px';
            else displayElement.style.fontSize = '90px';
        }

        function startMagicSequence(currentSum) {
            _isReady = false;
            _isFrozen = true; 
            previousValue = currentSum;
            statusDot.style.opacity = '0';
            setTimeout(() => { revealMagicNumber(); }, 5000);
        }

        function revealMagicNumber() {
            let finalTarget;
            if (magicMode === 'time') {
                const now = new Date();
                const M = (now.getMonth() + 1).toString().padStart(2, '0');
                const D = now.getDate().toString().padStart(2, '0');
                const H = now.getHours().toString().padStart(2, '0');
                const m = now.getMinutes().toString().padStart(2, '0');
                finalTarget = parseInt(`${M}${D}${H}${m}`);
            } else {
                finalTarget = fixedTargetValue;
            }
            let magicAddend = finalTarget - previousValue;
            if (Number.isInteger(magicAddend)) currentDisplay = String(magicAddend);
            else currentDisplay = String(Number(magicAddend.toFixed(8)));
            updateDisplay();
            _isFrozen = false;
            _isPostReveal = true; 
            if (navigator.vibrate) navigator.vibrate(200); 
        }

        function finalizeMagic() {
            const inputValue = parseFloat(currentDisplay);
            const finalResult = previousValue + inputValue;
            if (Number.isInteger(finalResult)) currentDisplay = String(finalResult);
            else currentDisplay = String(Number(finalResult.toFixed(8)));
            updateDisplay();
            _isPostReveal = false;
            previousValue = null;
            currentOperator = null;
            waitingForOperand = true;
        }
        
        /* ----------------------- */
        /* --- åœ£è¯ç‰¹æ•ˆé€»è¾‘æ–°å¢ --- */
        /* ----------------------- */
        
        let snowAnimationId = null;
        
        // 1. åˆå§‹åŒ–å¸½å­DOM
        function initSantaHats() {
            const buttons = document.querySelectorAll('.btn');
            const hatSvg = `
                <svg viewBox="0 0 1024 1024" width="100%" height="100%">
                    <path d="M512 85.333c-164.928 0-302.933 118.805-334.848 273.067h669.696c-31.915-154.262-169.92-273.067-334.848-273.067z" fill="#D81E06"></path>
                    <path d="M869.717 409.6H154.283c-23.21 0-42.667 19.456-42.667 42.667v85.333c0 23.21 19.456 42.667 42.667 42.667h715.434c23.21 0 42.667-19.456 42.667-42.667v-85.333c0-23.21-19.456-42.667-42.667-42.667z" fill="#FFFFFF"></path>
                    <circle cx="512" cy="65" r="50" fill="#FFFFFF"/>
                </svg>
            `;
            
            buttons.forEach(btn => {
                const hatDiv = document.createElement('div');
                hatDiv.className = 'santa-hat';
                hatDiv.innerHTML = hatSvg;
                btn.appendChild(hatDiv);
            });
        }
        
        // 2. å¼€å§‹ç‰¹æ•ˆ
        function startChristmasEffect() {
            // å¼€å§‹ä¸‹é›ª
            const canvas = document.getElementById('snow-canvas');
            canvas.style.display = 'block';
            startSnow(canvas);
            
            // å¸½å­ä¾æ¬¡å‡ºç°
            const hats = document.querySelectorAll('.santa-hat');
            // è·å–æ‰€æœ‰å¸½å­å¹¶æ‰“ä¹±ä¸€ç‚¹é¡ºåºæˆ–è€…æŒ‰æŒ‰é’®é¡ºåº
            // æŒ‰DOMé¡ºåºé€šå¸¸æ˜¯ 7,8,9,*,4,5,6...
            
            let delay = 0;
            const interval = 100; // æ¯ä¸ªå¸½å­é—´éš”100ms
            
            hats.forEach((hat, index) => {
                setTimeout(() => {
                    hat.classList.add('visible');
                    if (navigator.vibrate) navigator.vibrate(10); // è½»å¾®éœ‡åŠ¨åé¦ˆ
                    
                    // å¦‚æœæ˜¯æœ€åä¸€ä¸ªå¸½å­ï¼Œåœæ­¢ä¸‹é›ª
                    if (index === hats.length - 1) {
                        setTimeout(() => {
                            stopSnow();
                        }, 1500); // ç¨å¾®å¤šä¸‹1.5ç§’
                    }
                }, delay);
                delay += interval;
            });
        }
        
        // 3. é›ªèŠ±é€»è¾‘
        function startSnow(canvas) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width = window.innerWidth;
            const h = canvas.height = window.innerHeight;
            
            const particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: Math.random() * 3 + 1,
                    d: Math.random() * 100 // density
                });
            }
            
            let angle = 0;
            let isSnowing = true;
            
            function draw() {
                ctx.clearRect(0, 0, w, h);
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.beginPath();
                
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    ctx.moveTo(p.x, p.y);
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, true);
                }
                ctx.fill();
                update();
                
                if (isSnowing || particles.some(p => p.y < h)) {
                    snowAnimationId = requestAnimationFrame(draw);
                } else {
                    canvas.style.display = 'none'; // å½»åº•ç»“æŸåéšè—
                }
            }
            
            function update() {
                angle += 0.01;
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    p.y += Math.cos(angle + p.d) + 1 + p.r / 2;
                    p.x += Math.sin(angle) * 2;
                    
                    // å¦‚æœè¿˜åœ¨ä¸‹é›ªï¼Œä¸”é›ªèŠ±å‡ºäº†åº•éƒ¨ï¼Œé‡ç½®åˆ°é¡¶éƒ¨
                    if (p.x > w + 5 || p.x < -5 || p.y > h) {
                        if (isSnowing) {
                            if (i % 3 > 0) { // 2/3 of the flakes
                                particles[i] = {x: Math.random() * w, y: -10, r: p.r, d: p.d};
                            } else {
                                // If the flake is exitting from the right
                                if (Math.sin(angle) > 0) {
                                    particles[i] = {x: -5, y: Math.random() * h, r: p.r, d: p.d};
                                } else {
                                    particles[i] = {x: w + 5, y: Math.random() * h, r: p.r, d: p.d};
                                }
                            }
                        }
                    }
                }
            }
            
            // æš´éœ²åœæ­¢å‡½æ•°åˆ°å¤–éƒ¨é—­åŒ…
            window.stopSnow = function() {
                isSnowing = false;
            };
            
            draw();
        }

        window.onload = function() {
            loadSettings();
        };

    </script>
</body>
</html>